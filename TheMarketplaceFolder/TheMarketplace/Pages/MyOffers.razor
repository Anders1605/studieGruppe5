@page "/myoffers"
@using Services.OfferService;
@using Shared.Models;
@using System.Diagnostics
@inject IOfferService offerService;


<h3>My Offers</h3>

@* Old Code: *@
@* @if (ListingOffers is not null)
{
    @foreach (var item in ListingOffers)
    {
        <p>List of all offers</p>
        <ol>
            @if (item.OfferEmbedded is not null && item.OfferEmbedded.OfferAccepted is false)
            {
                <li>
                    <p>@item.Title</p>
                    <p>@item.Price</p>
                    <p>@item.OfferEmbedded.Buyer.Name</p>

                    <button class="btn btn-primary" @onclick="() => AcceptOffer(item.OfferEmbedded)"> Accept Offer</button>
                </li>
            }
        </ol>

        <p>List of accepted offers</p>

        if (item.OfferEmbedded is not null && item.OfferEmbedded.OfferAccepted is true)
        {
            <p>@item.Title</p>
            <p>@item.Price</p>
            <p>@item.OfferEmbedded.Buyer.Name</p>
        }
    }
    <button @onclick="ButtonTestClick"> This is a test </button>

} *@

@* ChatGPT Styled code *@
@if (ListingOffers is not null)
{
    var pendingOffers = ListingOffers
        .Where(o => o.OfferEmbedded is not null && o.OfferEmbedded.OfferAccepted == false)
        .ToList();

    var acceptedOffers = ListingOffers
        .Where(o => o.OfferEmbedded is not null && o.OfferEmbedded.OfferAccepted == true)
        .ToList();

    <div class="row">
        <div class="col-md-6">
            <h3>Pending Offers</h3>
            <ul class="list-group">
                @foreach (var offer in pendingOffers)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                            <h5>@offer.Title</h5>
                            <p>Price: @offer.Price</p>
                            <p>Buyer: @offer.OfferEmbedded.Buyer.Name</p>
                        </div>
                        <button class="btn btn-success" @onclick="() => AcceptOffer(offer.OfferEmbedded)">
                            Accept Offer
                        </button>
                    </li>
                }
            </ul>
        </div>

        <div class="col-md-6">
            <h3>Accepted Offers</h3>
            <ul class="list-group">
                @foreach (var offer in acceptedOffers)
                {
                    <li class="list-group-item">
                        <h5>@offer.Title</h5>
                        <p>Price: @offer.Price</p>
                        <p>Buyer: @offer.OfferEmbedded.Buyer.Name</p>
                    </li>
                }
            </ul>
        </div>
    </div>

    @* test for submitting offer, needs to be added to Listing Page, this line of code is difficult to test, since the offerService only fetches listingoffers. *@
    <button class="btn btn-warning mt-3" @onclick= "() =>SubmitOffer(ListingOffers[2])">Submit a test offer</button>
}


@code {

    public List<Listing>? ListingOffers;

    public User MockBuyer;

    public User MockSeller;

    protected override async void OnInitialized()
    {
        base.OnInitialized();

        MockBuyer = new User()
            {
                Name = "Buyer",
                Address = "testAddress",
                EmailAddress = "TestBuyer@email.dk",
                Password = "testPassword",
                ProfilePictureUrl = "none",
                TelephoneNumber = "1234567890"
            };

        MockSeller = new User()
            {
                Name = "Seller",
                Address = "testAddress",
                EmailAddress = "test1@mail.com",
                Password = "testPassword",
                ProfilePictureUrl = "none",
                TelephoneNumber = "0987654321"
            };

        ListingOffers = await offerService.GetAllListingsWithOffers(MockSeller);

        Console.WriteLine(ListingOffers.Count);
    }

    public void ButtonTestClick()
    {
        Console.WriteLine("This is a test");
    }

    public async void AcceptOffer(Offer offerToAccept)
    {
        await offerService.AcceptOffer(offerToAccept);
        ListingOffers = await offerService.GetAllListingsWithOffers(MockSeller);
        Debug.WriteLine(ListingOffers.Count);
    }

    public async void SubmitOffer(Listing itemToSubmitOfferFor)
    {
        await offerService.SubmitOffer(itemToSubmitOfferFor, MockBuyer);
        ListingOffers = await offerService.GetAllListingsWithOffers(MockSeller);
    }

}
